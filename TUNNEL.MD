# ğŸŒ è‡ªè£½ Ngrok éš§é“ç³»çµ±éƒ¨ç½²æŒ‡å—

## ç³»çµ±æ¶æ§‹

```
[æœ¬åœ°Webæœå‹™] <-> [éš§é“å®¢æˆ¶ç«¯] <==ç¶²è·¯==> [éš§é“æœå‹™å™¨] <-> [å…¬ç¶²ç”¨æˆ¶]
 localhost:8080     ä½ çš„é›»è…¦              VPSæœå‹™å™¨        äº’è¯ç¶²
```

## ğŸ“¦ æ–‡ä»¶çµæ§‹

```
tunnel_system/
â”œâ”€â”€ tunnel_common.h      # å”è­°å®šç¾©
â”œâ”€â”€ tunnel_common.c      # å”è­°å¯¦ç¾
â”œâ”€â”€ tunnel_client.c      # å®¢æˆ¶ç«¯ç¨‹åº
â”œâ”€â”€ tunnel_server.c      # æœå‹™å™¨ç¨‹åº
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ logger.h        # æ—¥èªŒç³»çµ±
â”‚   â””â”€â”€ logger.c
â””â”€â”€ Makefile
```

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### Step 1: ç·¨è­¯

```bash
# ç·¨è­¯æ‰€æœ‰
make

# åªç·¨è­¯å®¢æˆ¶ç«¯ï¼ˆæœ¬åœ°ä½¿ç”¨ï¼‰
make client

# åªç·¨è­¯æœå‹™å™¨ï¼ˆVPSä½¿ç”¨ï¼‰
make server
```

### Step 2: éƒ¨ç½²æœå‹™å™¨ï¼ˆåœ¨VPSä¸Šï¼‰

#### 2.1 æº–å‚™VPS
- éœ€è¦ä¸€å€‹æœ‰å…¬ç¶²IPçš„VPSï¼ˆå¦‚ DigitalOcean, Linode, AWS EC2ï¼‰
- ç³»çµ±ï¼šUbuntu/Debian/CentOS
- é–‹æ”¾ç«¯å£ï¼š80, 7000, 7001

#### 2.2 åœ¨VPSä¸Šç·¨è­¯å’Œé‹è¡Œ

```bash
# SSHé€£æ¥åˆ°VPS
ssh root@your-vps-ip

# å®‰è£ä¾è³´
apt-get update
apt-get install gcc make git

# ä¸‹è¼‰ä»£ç¢¼
git clone your-repo
cd tunnel_system

# ç·¨è­¯æœå‹™å™¨
make server

# é‹è¡Œæœå‹™å™¨ï¼ˆå»ºè­°ç”¨screenæˆ–systemdï¼‰
./tunnel_server

# æˆ–ä½¿ç”¨screenä¿æŒå¾Œå°é‹è¡Œ
screen -S tunnel
./tunnel_server
# Ctrl+A+D åˆ†é›¢screen
```

#### 2.3 é…ç½®åŸŸåï¼ˆå¯é¸ï¼‰

å¦‚æœä½ æœ‰åŸŸåï¼Œé…ç½®DNSï¼š
```
*.tunnel.yourdomain.com -> VPS_IP
```

æˆ–ä½¿ç”¨ xip.io æœå‹™ï¼š
```
http://subdomain.VPS_IP.xip.io
```

### Step 3: é‹è¡Œå®¢æˆ¶ç«¯ï¼ˆæœ¬åœ°ï¼‰

```bash
# 1. å•Ÿå‹•ä½ çš„Webæœå‹™
./webserver.exe 8080

# 2. å•Ÿå‹•éš§é“å®¢æˆ¶ç«¯
./tunnel_client.exe vps-ip 7000 8080

# è¼¸å‡ºç¤ºä¾‹ï¼š
# ========================================
#   Tunnel established successfully!
#   Public URL: http://abc123.tunnel.example.com
#   Forwarding to: localhost:8080
# ========================================
```

## ğŸ”§ é«˜ç´šé…ç½®

### ä½¿ç”¨ systemd ç®¡ç†æœå‹™å™¨ï¼ˆæ¨è–¦ï¼‰

å‰µå»º `/etc/systemd/system/tunnel-server.service`:

```ini
[Unit]
Description=Tunnel Server
After=network.target

[Service]
Type=simple
User=tunnel
WorkingDirectory=/opt/tunnel
ExecStart=/opt/tunnel/tunnel_server
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å•Ÿå‹•æœå‹™ï¼š
```bash
systemctl enable tunnel-server
systemctl start tunnel-server
systemctl status tunnel-server
```

### ä½¿ç”¨ Nginx åå‘ä»£ç†ï¼ˆå¯é¸ï¼‰

å¦‚æœä½ æƒ³ä½¿ç”¨æ¨™æº–80ç«¯å£ä¸¦æ”¯æŒHTTPSï¼š

```nginx
server {
    listen 80;
    server_name *.tunnel.yourdomain.com;
    
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocketæ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### æ·»åŠ èªè­‰åŠŸèƒ½

ä¿®æ”¹ `tunnel_server.c` æ·»åŠ tokené©—è­‰ï¼š

```c
// åœ¨ handle_control_connection å‡½æ•¸ä¸­
if (strcmp(req->token, "your-secret-token") != 0) {
    tunnel_send_msg(client_sock, TUNNEL_REJECT, 0, NULL, 0);
    close(client_sock);
    return NULL;
}
```

## ğŸ“Š ç›£æ§å’Œæ—¥èªŒ

### æŸ¥çœ‹æœå‹™å™¨æ—¥èªŒ
```bash
tail -f tunnel_server.log
```

### æŸ¥çœ‹å®¢æˆ¶ç«¯æ—¥èªŒ
```bash
tail -f tunnel_client.log
```

### ç›£æ§é€£æ¥ç‹€æ…‹
```bash
# æŸ¥çœ‹ç«¯å£ç›£è½
netstat -tlnp | grep tunnel

# æŸ¥çœ‹æ´»å‹•é€£æ¥
ss -tnp | grep :7000
```

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### å•é¡Œ 1: ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨
```bash
# æª¢æŸ¥é˜²ç«ç‰†
ufw allow 80/tcp
ufw allow 7000/tcp
ufw allow 7001/tcp

# æˆ–é—œé–‰é˜²ç«ç‰†æ¸¬è©¦
ufw disable
```

### å•é¡Œ 2: åŸŸåç„¡æ³•è¨ªå•
```bash
# æª¢æŸ¥DNSè§£æ
nslookup subdomain.tunnel.yourdomain.com

# ä½¿ç”¨IPç›´æ¥è¨ªå•æ¸¬è©¦
curl http://VPS_IP
```

### å•é¡Œ 3: é€£æ¥ä¸ç©©å®š
- å¢åŠ å¿ƒè·³é »ç‡
- èª¿æ•´è¶…æ™‚æ™‚é–“
- ä½¿ç”¨æ›´ç©©å®šçš„VPSæä¾›å•†

## ğŸ¯ æ€§èƒ½å„ªåŒ–

### 1. å¢åŠ ç·©è¡å€å¤§å°
```c
#define TUNNEL_BUFFER_SIZE 131072  // 128KB
```

### 2. ä½¿ç”¨å¤šç·šç¨‹æ± 
```c
// é å‰µå»ºç·šç¨‹æ± è™•ç†é€£æ¥
ThreadPool* pool = thread_pool_create(100);
```

### 3. å•Ÿç”¨TCPå„ªåŒ–
```c
int flag = 1;
setsockopt(sock, IPPROTO_TCP, TCP_NODELAY, &flag, sizeof(flag));
```

## ğŸ“ˆ æ“´å±•åŠŸèƒ½

### æ”¯æŒçš„æ“´å±•
- âœ… å¤šå®¢æˆ¶ç«¯æ”¯æŒ
- âœ… è‡ªå®šç¾©å­åŸŸå
- âœ… å¿ƒè·³ä¿æ´»
- âœ… æœƒè©±ç®¡ç†

### å¯ä»¥æ·»åŠ çš„åŠŸèƒ½
- [ ] HTTPSæ”¯æŒ
- [ ] WebSocketä»£ç†
- [ ] æµé‡çµ±è¨ˆ
- [ ] å¸¶å¯¬é™åˆ¶
- [ ] å¤šç«¯å£è½‰ç™¼
- [ ] UDPéš§é“
- [ ] å£“ç¸®å‚³è¼¸
- [ ] åŠ å¯†é€šé“

## ğŸ” å®‰å…¨å»ºè­°

1. **ä½¿ç”¨Tokenèªè­‰**
   ```bash
   ./tunnel_client vps-ip 7000 8080 secret-token
   ```

2. **é™åˆ¶ä¾†æºIP**
   ```c
   // åªå…è¨±ç‰¹å®šIPé€£æ¥
   if (strcmp(inet_ntoa(client_addr.sin_addr), "allowed-ip") != 0) {
       close(client_sock);
       return;
   }
   ```

3. **ä½¿ç”¨TLSåŠ å¯†**
   - å¯ä»¥æ•´åˆ OpenSSL æˆ– mbedTLS

4. **é™åˆ¶è³‡æºä½¿ç”¨**
   - é™åˆ¶æœ€å¤§é€£æ¥æ•¸
   - é™åˆ¶å¸¶å¯¬ä½¿ç”¨
   - è¨­ç½®è¶…æ™‚æ™‚é–“

## ğŸ“ å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### æœ¬åœ°é–‹ç™¼ç’°å¢ƒ
```bash
# 1. VPSä¸Šé‹è¡Œæœå‹™å™¨
ssh root@vps-ip
./tunnel_server

# 2. æœ¬åœ°é‹è¡ŒWebæœå‹™
./webserver.exe 3000

# 3. å‰µå»ºéš§é“
./tunnel_client.exe vps-ip 7000 3000

# 4. åˆ†äº«å…¬ç¶²åœ°å€
# http://abc123.vps-ip.xip.io
```

### ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²
```bash
# ä½¿ç”¨supervisorç®¡ç†
[program:tunnel-server]
command=/opt/tunnel/tunnel_server
autostart=true
autorestart=true
stderr_logfile=/var/log/tunnel.err.log
stdout_logfile=/var/log/tunnel.out.log
```

## ğŸ‰ æˆåŠŸæ¨™èªŒ

ç•¶ä½ çœ‹åˆ°ä»¥ä¸‹å…§å®¹ï¼Œè¡¨ç¤ºç³»çµ±é‹è¡ŒæˆåŠŸï¼š

**æœå‹™å™¨ç«¯ï¼š**
```
========================================
  Tunnel Server Starting...
  HTTP Port: 80
  Control Port: 7000
  Data Port: 7001
========================================
[INFO] HTTP server listening on port 80
[INFO] Control server listening on port 7000
[INFO] Client connected: default -> http://abc123.tunnel.example.com
```

**å®¢æˆ¶ç«¯ï¼š**
```
========================================
  Tunnel established successfully!
  Public URL: http://abc123.tunnel.example.com
  Forwarding to: localhost:8080
========================================
```

ç¾åœ¨ä½ å°±æœ‰äº†è‡ªå·±çš„ ngrokï¼è¨ªå•åˆ†é…çš„å…¬ç¶²URLå³å¯è¨ªå•ä½ çš„æœ¬åœ°æœå‹™ã€‚